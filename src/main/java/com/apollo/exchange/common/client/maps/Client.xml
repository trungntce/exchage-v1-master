<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="Client">

    <!-- 토큰 리스트 카운트. -->
    <select id="selectCount" parameterType="com.apollo.exchange.common.client.dto.ClientSearchDTO" resultType="int">
        <![CDATA[
            SELECT
                COUNT(C.CLIENT_ID)
            FROM
                CLIENT C
                INNER JOIN WALLET_CLIENT WC ON C.CLIENT_ID = WC.CLIENT_ID
                INNER JOIN WALLET W ON WC.WALLET_ID = W.WALLET_ID
                INNER JOIN WALLET_ROLE WR ON W.WALLET_ID = WR.WALLET_ID
            WHERE 1 AND WR.ROLE = 'CLIENT'
        ]]>
            <if test="symbol != null &amp;&amp; symbol !=''">
                <![CDATA[    AND C.SYMBOL = '${symbol}' ]]>
            </if>
            <if test="keywordType != null &amp;&amp; keywordType !=''">
                <![CDATA[       AND ${keywordType} like '%${keyword}%' ]]>
            </if>
            <if test="apiKey != null &amp;&amp; apiKey != ''"> AND C.API_KEY = #{apiKey} </if>
            <if test="clientCode != null &amp;&amp; clientCode != ''"> AND C.CLIENT_CODE = #{clientCode} </if>
            <if test="timeSearchKey != null &amp;&amp; timeSearchKey !=''">
                <if test="searchDateStart != null &amp;&amp; searchDateStart !=''">
                    <![CDATA[ AND ${timeSearchKey} >= '${searchDateStart}' ]]>
                </if>
                <if test="searchDateEnd != null &amp;&amp; searchDateEnd !=''">
                    <![CDATA[ AND ${timeSearchKey} <= '${searchDateEnd}' ]]>
                </if>
            </if>
    </select>

    <!-- 토큰 리스트 가져오기. -->
    <select id="selectClientList" parameterType="com.apollo.exchange.common.client.dto.ClientSearchDTO" resultType="com.apollo.exchange.common.client.dto.ClientDTO">
        <![CDATA[
            SELECT *
            FROM (
                 SELECT
                    @ROWNUM := @ROWNUM + 1 AS ROWNUM
                    , A.*
                 FROM (
                     SELECT
                         C.CLIENT_ID
                         , C.SYMBOL
                         , C.CLIENT_CODE
                         , C.API_KEY
                         , C.NAME
                         , C.USE_YN
                         , C.FEE
                         , C.REG_DATE
                         , W.WALLET_ADDRESS
                     FROM
                        CLIENT C
                        INNER JOIN WALLET_CLIENT WC ON C.CLIENT_ID = WC.CLIENT_ID
                        INNER JOIN WALLET W ON WC.WALLET_ID = W.WALLET_ID
                        INNER JOIN WALLET_ROLE WR ON W.WALLET_ID = WR.WALLET_ID
                    WHERE 1 AND WR.ROLE = 'CLIENT'
        ]]>
                    <if test="symbol != null &amp;&amp; symbol !=''">
                        <![CDATA[    AND C.SYMBOL = '${symbol}' ]]>
                    </if>
                    <if test="keywordType != null &amp;&amp; keywordType !=''">
                        <![CDATA[    AND ${keywordType} like '%${keyword}%' ]]>
                    </if>
                    <if test="apiKey != null &amp;&amp; apiKey != ''"> AND C.API_KEY = #{apiKey} </if>
                    <if test="clientCode != null &amp;&amp; clientCode != ''"> AND C.CLIENT_CODE = #{clientCode} </if>
                    <if test="timeSearchKey != null &amp;&amp; timeSearchKey !=''">
                        <if test="searchDateStart != null &amp;&amp; searchDateStart !=''">
                            <![CDATA[ AND ${timeSearchKey} >= '${searchDateStart}' ]]>
                        </if>
                        <if test="searchDateEnd != null &amp;&amp; searchDateEnd !=''">
                            <![CDATA[ AND ${timeSearchKey} <= '${searchDateEnd}' ]]>
                        </if>
                    </if>
        <![CDATA[
                 ) A, (SELECT @ROWNUM :=0) TEMP
        ]]>
        <if test="orderByColumn != null &amp;&amp; orderByColumn !=''">
        <![CDATA[ ORDER BY ${orderByColumn} ${orderByType} ]]>
        </if>
        <![CDATA[
                 LIMIT ${start}, ${limit}
             ) RESULT
        ]]>
    </select>

    <select id="selectClientOwner" parameterType="com.apollo.exchange.common.client.dto.ClientSearchDTO" resultType="com.apollo.exchange.common.client.dto.ClientDTO">
        SELECT
            C.CLIENT_ID
            , C.CLIENT_CODE
            , C.SYMBOL
            , C.API_KEY
            , C.NAME
            , C.USE_YN
            , C.FEE
            , T.UNIT_PRICE
            , W.WALLET_ADDRESS
            , W.BANK_NAME
            , W.BANK_OWNER
            , W.BANK_ACCOUNT
            , W.NAME AS WALLET_NAME
            , WR.ROLE
        FROM
            CLIENT C
        INNER JOIN TOKEN T ON C.SYMBOL = T.SYMBOL
        INNER JOIN WALLET_CLIENT WC ON C.CLIENT_ID = WC.CLIENT_ID
        INNER JOIN WALLET W ON WC.WALLET_ID = W.WALLET_ID
        INNER JOIN WALLET_ROLE WR ON W.WALLET_ID = WR.WALLET_ID
        WHERE
            WR.ROLE = #{role}
    </select>

    <!-- 토큰 상세 가져오기. -->
    <select id="selectOne" parameterType="com.apollo.exchange.common.client.dto.ClientSearchDTO" resultType="com.apollo.exchange.common.client.dto.ClientDTO">
        SELECT
            C.CLIENT_ID
            , C.SYMBOL
            , C.CLIENT_CODE
            , C.API_KEY
            , C.NAME
            , C.USE_YN
            , C.FEE
            , C.BUY_FEE
            , C.SELL_FEE
            , C.REG_DATE
            , W.WALLET_ADDRESS
            , W.BANK_NAME
            , W.BANK_OWNER
            , W.BANK_ACCOUNT
        FROM
            CLIENT C
            INNER JOIN WALLET_CLIENT WC ON C.CLIENT_ID = WC.CLIENT_ID
            INNER JOIN WALLET W ON WC.WALLET_ID = W.WALLET_ID
            INNER JOIN WALLET_ROLE WR ON W.WALLET_ID = WR.WALLET_ID
        WHERE  WR.ROLE = 'CLIENT'
        <if test="clientId != null &amp;&amp; clientId != ''"> AND C.CLIENT_ID = #{clientId} </if>
        <if test="clientCode != null &amp;&amp; clientCode != ''"> AND C.CLIENT_CODE = #{clientCode} </if>
        <if test="apiKey != null &amp;&amp; apiKey != ''"> AND C.API_KEY = #{apiKey} </if>
    </select>

    <update id="updateOne" parameterType="com.apollo.exchange.common.client.dto.ClientDTO">
        UPDATE
            CLIENT
        SET
            SYMBOL = #{symbol}
            , CLIENT_CODE = #{clientCode}
            , API_KEY = #{apiKey}
            , NAME = #{name}
            , USE_YN = #{useYn}
            , FEE = #{fee}
        WHERE
            CLIENT_ID = #{clientId}
    </update>

    <insert id="insertOne" parameterType="com.apollo.exchange.common.client.dto.ClientDTO" useGeneratedKeys="true" keyProperty="clientId" keyColumn="client_id">
        INSERT INTO CLIENT (SYMBOL, CLIENT_CODE, API_KEY, NAME, USE_YN, FEE)
        VALUES (#{symbol}, #{clientCode}, #{apiKey}, #{name}, #{useYn}, #{fee})
    </insert>

    <select id="selectOneByApiKey" parameterType="String" resultType="com.apollo.exchange.common.client.dto.ClientDTO">
        SELECT
        CLIENT_ID
        , SYMBOL
        , CLIENT_CODE
        , API_KEY
        , NAME
        , USE_YN
        , FEE
        , REG_DATE
        FROM
        CLIENT
        WHERE
        API_KEY = #{apiKey}
    </select>
    <select id="selectClientAndClientTraderByClientId" resultType="com.apollo.exchange.common.client.dto.ClientDTO">
        SELECT
            C.CLIENT_ID
            , C.SYMBOL
            , C.BUY_FEE
            , C.SELL_FEE
            , C.CLIENT_TRADER_USE_YN
            , C.BUY_BENIFIT_USE_YN
            , C.SELL_BENIFIT_USE_YN
            , WCT.WALLET_CLIENT_TRADER_ID
            , WCT.WALLET_ID AS CLIENT_TRADER_WALLET
            , WCT.USE_YN_FEE_OP
        FROM CLIENT  C
            LEFT JOIN WALLET_CLIENT_TRADER WCT
                ON C.CLIENT_ID = WCT.CLIENT_ID
        WHERE C.CLIENT_ID = #{clientId}
            AND C.USE_YN = 'Y';
    </select>
</mapper>
