<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="AdminBuySafe">

    <select id="selectCount" parameterType="com.apollo.exchange.admin.buy.dto.AdminBuySearchDTO" resultType="java.lang.Integer">
        SELECT COUNT(TB.BUY_ID)
        FROM TOKEN_BUY TB
        INNER JOIN TOKEN_BUY TB_REF ON TB.BUY_ID = TB_REF.P_BUY_ID
        LEFT JOIN TOKEN_BUY_TRADE_HISTORY TBTH ON TB.BUY_ID = TBTH.BUY_ID
        LEFT JOIN CLIENT C ON TB.CLIENT_ID = C.CLIENT_ID
        WHERE TB.BUY_ID IN (SELECT P_BUY_ID FROM TOKEN_BUY WHERE BUYER_WALLET_ADDRESS = #{walletAddress} AND VIEW_ROLE = 'OWNER_SAFE')
        AND TBTH.TRADE_STATE = 4 AND TB.STATE != 3
        <if test="clientCode != null &amp;&amp; clientCode !=''"> AND C.CLIENT_CODE = #{clientCode} </if>
        <if test="keywordType != null &amp;&amp; keywordType !=''"> AND ${keywordType} like '%${keyword}%' </if>
    </select>

    <select id="selectList" parameterType="com.apollo.exchange.admin.buy.dto.AdminBuySearchDTO" resultType="com.apollo.exchange.admin.buy.dto.AdminBuyDTO">
        SELECT *
        FROM (
            SELECT
                @ROWNUM := @ROWNUM + 1 AS ROWNUM
                , A.*
            FROM (
                SELECT
                    TB.BUY_ID
                    , TB.P_BUY_ID
                    , TB.CLIENT_ID
                    , C.NAME AS CLIENT_NAME
                    , TB.BUY_TYPE
                    , TB.SYMBOL
                    , TB.VIEW_ROLE
                    , TB.BUYER_WALLET_ADDRESS
                    , (SELECT NAME FROM WALLET WHERE WALLET_ADDRESS = TB.BUYER_WALLET_ADDRESS) AS BUYER_NAME
                    , TB.QUANTITY
                    , TB.UNIT_PRICE
                    , TB.TOTAL_PRICE
                    , TB.STATE
                    , (SELECT CODE_NAME FROM COMMON_CODE WHERE GROUP_NAME = 'STATE' AND CODE_VALUE=TB.STATE AND LANG_CODE='${langCode}') AS STATE_NAME
                    , TB.DEL_YN
                    , TBTH.TRADE_STATE
                    , (SELECT CODE_NAME FROM COMMON_CODE WHERE GROUP_NAME = 'BUY_TRADE_STATE' AND CODE_VALUE=TBTH.TRADE_STATE AND LANG_CODE='${langCode}') AS TRADE_STATE_NAME
                    , TBTH.SELLER_WALLET_ADDRESS
                    , (SELECT NAME FROM WALLET WHERE WALLET_ADDRESS = TBTH.SELLER_WALLET_ADDRESS) AS SELLER_NAME
                    , TBTH.TXID
                    , TBTH.BANK_NAME
                    , TBTH.BANK_OWNER
                    , TBTH.BANK_ACCOUNT
                    , TB.TRADE_COMPLETION_DATE
                    , TB.REG_DATE
                    , TB.REG_WALLET_ADDRESS
                    , TB_REF.BUY_ID AS REF_BUY_ID
                    , TB_REF.STATE AS REF_BUY_STATE
                FROM TOKEN_BUY TB
                INNER JOIN TOKEN_BUY TB_REF ON TB.BUY_ID = TB_REF.P_BUY_ID
                LEFT JOIN TOKEN_BUY_TRADE_HISTORY TBTH ON TB.BUY_ID = TBTH.BUY_ID
                LEFT JOIN CLIENT C ON TB.CLIENT_ID = C.CLIENT_ID
                WHERE TB.BUY_ID IN (SELECT P_BUY_ID FROM TOKEN_BUY WHERE BUYER_WALLET_ADDRESS = #{walletAddress} AND VIEW_ROLE = 'OWNER_SAFE')
                AND TBTH.TRADE_STATE = 4 AND TB.STATE != 3
                <if test="clientCode != null &amp;&amp; clientCode !=''"> AND C.CLIENT_CODE = #{clientCode} </if>
                <if test="keywordType != null &amp;&amp; keywordType !=''"> AND ${keywordType} like '%${keyword}%' </if>
                 ) A, (SELECT @ROWNUM :=0) TEMP
                 ORDER BY ${orderByColumn} ${orderByType}
                 LIMIT ${start}, ${limit}
            ) RESULT
    </select>
</mapper>